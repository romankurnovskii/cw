{"code":"(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{2953:function(e,t,r){var a=r(5),s=r(2954);\"string\"==typeof(s=s.__esModule?s.default:s)&&(s=[[e.i,s,\"\"]]);var o={insert:\"head\",singleton:!1};a(s,o);e.exports=s.locals||{}},2954:function(e,t,r){(t=r(6)(!1)).push([e.i,\".load-factory-page {\\n  overflow: hidden;\\n  padding-left: 0;\\n  padding-right: 0;\\n  padding-bottom: 0;\\n}\\n.load-factory-page .pf-c-empty-state {\\n  padding-bottom: calc(100vh - 380px);\\n}\\n.load-factory-wizard .pf-c-wizard__nav {\\n  width: 100%;\\n  border: none;\\n  pointer-events: none;\\n}\\n.load-factory-wizard .pf-c-wizard__nav .error {\\n  color: #000;\\n}\\n.load-factory-wizard .pf-c-wizard__nav .error,\\n.load-factory-wizard .pf-c-wizard__nav .progress {\\n  font-weight: bold;\\n}\\n.load-factory-wizard .pf-c-wizard__nav .progress {\\n  color: #0766cc;\\n}\\n.load-factory-wizard .pf-c-wizard__nav .pf-c-wizard__nav-link {\\n  margin-left: 8px;\\n}\\n.load-factory-wizard .pf-c-wizard__nav .pf-c-wizard__nav-link > svg {\\n  margin-right: 5px;\\n}\\n.load-factory-wizard .pf-c-wizard__nav .pf-c-wizard__nav-link .wizard-icon {\\n  position: absolute;\\n  left: -56px;\\n  top: 3px;\\n}\\n.load-factory-wizard .pf-c-wizard__toggle {\\n  padding-left: 56px;\\n}\\n.load-factory-wizard .pf-c-wizard__toggle .pf-c-wizard__toggle-list-item > svg {\\n  margin-right: 5px;\\n}\\n.load-factory-wizard .pf-c-wizard__toggle .pf-c-wizard__toggle-list-item .wizard-icon {\\n  position: absolute;\\n  left: -56px;\\n  top: 3px;\\n}\\n\",\"\"]),e.exports=t},2974:function(e,t,r){\"use strict\";r.r(t),r.d(t,\"LoadFactorySteps\",(function(){return K})),r.d(t,\"FactoryLoaderContainer\",(function(){return G}));var a=r(2904),s=r(1),o=r.n(s),i=r(59),n=r(330),c=r(331),l=r(113),p=r(2884),d=r(89),h=r(2849),u=r(2907),f=r(2830),w=r(2903),v=r(2857),g=r(2900),m=r(329),E=r(2921),y=r(15),I=r(2922),R=r(102),b=r.n(R);r(2953);const S=h.b.light;var _;!function(e){e[e.Progress=0]=\"Progress\",e[e.Logs=1]=\"Logs\"}(_||(_={}));class O extends o.a.PureComponent{constructor(e){let t;super(e),this.state={alertVisible:!1,activeTabKey:_.Progress,currentRequestError:\"\"},this.wizardRef=o.a.createRef(),this.handleTabClick=(e,t)=>{this.setState({activeTabKey:t}),this.state.activeTabKey===_.Progress&&this.setState({alertVisible:!1})},this.showAlert=(e,r)=>{this.setState({currentRequestError:r,currentAlertVariant:e}),this.state.activeTabKey!==_.Progress&&(this.setState({alertVisible:!0}),t&&clearTimeout(t),t=setTimeout(()=>{this.setState({alertVisible:!1})},e===a.b.success?2e3:1e4))},this.hideAlert=()=>this.setState({alertVisible:!1}),this.props.callbacks&&!this.props.callbacks.showAlert&&(this.props.callbacks.showAlert=(e,t)=>{this.showAlert(e,t)})}componentDidUpdate(){const{currentStep:e,hasError:t}=this.props,r=this.wizardRef.current;r&&r.state&&r.state.currentStep!==e&&!t&&(r.state.currentStep=e)}getIcon(e,t=\"\"){const{currentStep:r,hasError:a}=this.props;return r>e?o.a.createElement(o.a.Fragment,null,o.a.createElement(p.a,{className:t,color:\"green\"})):r===e?a?o.a.createElement(d.ExclamationCircleIcon,{className:t,color:\"red\"}):o.a.createElement(o.a.Fragment,null,o.a.createElement(d.InProgressIcon,{className:`${b.a.rotate} ${t}`,color:\"#0e6fe0\"})):\"\"}getSteps(){const{currentStep:e,devfileLocationInfo:t,hasError:r}=this.props,a=(t,a,s)=>{let i=\"\";return e===t&&(i=r?\"error\":\"progress\"),o.a.createElement(o.a.Fragment,null,this.getIcon(t,s),o.a.createElement(\"span\",{className:i},a))};return[{id:K.INITIALIZING,name:a(K.INITIALIZING,\"Initializing\",\"wizard-icon\"),canJumpTo:e>=K.INITIALIZING},{name:a(K.CREATE_WORKSPACE,\"Creating a workspace\",\"wizard-icon\"),steps:[{id:K.LOOKING_FOR_DEVFILE,name:a(K.LOOKING_FOR_DEVFILE,e<=K.LOOKING_FOR_DEVFILE?\"Looking for devfile\":t?\"Devfile is found as \"+t:\"Devfile is not found \"+(r?\"\":\"in repository root. Default environment will be applied\")),canJumpTo:e>=K.LOOKING_FOR_DEVFILE},{id:K.APPLYING_DEVFILE,name:a(K.APPLYING_DEVFILE,\"Applying devfile\"),canJumpTo:e>=K.APPLYING_DEVFILE}]},{id:K.START_WORKSPACE,name:a(K.START_WORKSPACE,\"Waiting for workspace to start\",\"wizard-icon\"),canJumpTo:e>=K.START_WORKSPACE},{id:K.OPEN_IDE,name:a(K.OPEN_IDE,\"Open IDE\",\"wizard-icon\"),canJumpTo:e>=K.OPEN_IDE}]}render(){const{workspaceName:e,workspaceId:t,hasError:r,currentStep:s}=this.props,{alertVisible:i,currentRequestError:n,currentAlertVariant:c}=this.state;return o.a.createElement(o.a.Fragment,null,o.a.createElement(m.a,{pageName:\"Factory Loader\"}),i&&o.a.createElement(u.a,{isToast:!0},o.a.createElement(a.a,{variant:c,title:n,actionClose:o.a.createElement(f.a,{onClose:this.hideAlert})})),o.a.createElement(E.a,{title:\"Starting workspace \"+e,status:r?y.e[y.e.ERROR]:y.e[y.e.STARTING]}),o.a.createElement(h.a,{variant:S,className:\"load-factory-page\",isFilled:!0},o.a.createElement(w.a,{activeKey:this.state.activeTabKey,onSelect:this.handleTabClick,inset:{default:\"insetLg\"},id:\"factory-loader-page-tabs\"},o.a.createElement(v.a,{eventKey:_.Progress,title:_[_.Progress],id:\"factory-loader-page-wizard-tab\"},o.a.createElement(h.a,null,this.state.currentRequestError&&o.a.createElement(a.a,{isInline:!0,variant:c,title:n,actionClose:o.a.createElement(f.a,{onClose:()=>this.setState({currentRequestError:\"\"})})}),o.a.createElement(g.a,{className:\"load-factory-wizard\",steps:this.getSteps(),ref:this.wizardRef,footer:o.a.createElement(\"span\",null),height:300,startAtStep:s}))),o.a.createElement(v.a,{eventKey:_.Logs,title:_[_.Logs],id:\"factory-loader-page-logs-tab\"},o.a.createElement(I.a,{workspaceId:t})))))}}var A=O,P=r(255),k=r(114),L=r(348),N=r(23),T=r(51),D=r(263),F=r(256),z=function(e,t,r,a){var s,o=arguments.length,i=o<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if(\"object\"==typeof Reflect&&\"function\"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,a);else for(var n=e.length-1;n>=0;n--)(s=e[n])&&(i=(o<3?s(i):o>3?s(t,r,i):s(t,r))||i);return o>3&&i&&Object.defineProperty(t,r,i),i},C=function(e,t){if(\"object\"==typeof Reflect&&\"function\"==typeof Reflect.metadata)return Reflect.metadata(e,t)};const W=[\"workspaceDeploymentLabels\",\"workspaceDeploymentAnnotations\",\"policies.create\"];var K;!function(e){e[e.INITIALIZING=0]=\"INITIALIZING\",e[e.CREATE_WORKSPACE=1]=\"CREATE_WORKSPACE\",e[e.LOOKING_FOR_DEVFILE=2]=\"LOOKING_FOR_DEVFILE\",e[e.APPLYING_DEVFILE=3]=\"APPLYING_DEVFILE\",e[e.START_WORKSPACE=4]=\"START_WORKSPACE\",e[e.OPEN_IDE=5]=\"OPEN_IDE\"}(K||(K={}));class G extends o.a.PureComponent{constructor(e){super(e),this.factoryLoaderCallbacks={},this.overrideDevfileObject={};const{search:t}=this.props.history.location;this.state={currentStep:K.INITIALIZING,hasError:!1,createPolicy:\"perclick\",search:t}}resetOverrideParams(){this.overrideDevfileObject={}}updateOverrideParams(e,t){if(e.startsWith(\"override.\")){const r=[],a=new RegExp(\"([^.=]+)\",\"g\");let s=null;for(;null!==(s=a.exec(e));)r.push(s[0]);if(r.length>0){let e=this.overrideDevfileObject;for(let a=1;a<r.length;a++)e[r[a]]=a===r.length-1?t:{},e=e[r[a]]}}}getTargetDevfile(){var e,t;let r=this.factoryResolver.resolver.devfile;if(r)return r=Object(L.merge)(r,this.overrideDevfileObject),void 0===(null===(e=null==r?void 0:r.attributes)||void 0===e?void 0:e.persistVolumes)&&void 0===(null===(t=null==r?void 0:r.attributes)||void 0===t?void 0:t.asyncPersist)&&this.props.preferredStorageType&&(r=Object(F.f)(r,this.props.preferredStorageType)),r}showAlert(e,t=a.b.danger){t===a.b.danger&&this.setState({hasError:!0}),this.factoryLoaderCallbacks.showAlert?this.factoryLoaderCallbacks.showAlert(t,e):console.error(e)}componentDidMount(){this.createWorkspaceFromFactory()}async componentDidUpdate(){const{history:e,workspace:t,factoryResolver:r}=this.props;if(this.state.search!==e.location.search)return this.setState({search:e.location.search,hasError:!1}),this.createWorkspaceFromFactory();r&&(this.factoryResolver=r),this.state.currentStep===K.START_WORKSPACE&&t&&y.e[t.status]===y.e.RUNNING&&await this.openIde(),t&&y.e[t.status]===y.e.ERROR&&this.state.currentStep===K.START_WORKSPACE&&this.showAlert(\"Unknown workspace error.\")}async openIde(){const{history:e,workspace:t}=this.props;if(t&&y.e[t.status]===y.e.RUNNING){this.setState({currentStep:K.OPEN_IDE});try{await this.props.requestWorkspace(t)}catch(e){this.showAlert(\"Getting workspace detail data failed. \"+e)}await Object(n.a)(),e.push(Object(k.d)(t))}}isCreatePolicy(e){return e&&\"perclick\"===e||\"peruser\"===e}getCreatePolicy(e){const t=e[\"policies.create\"]||\"perclick\";if(this.isCreatePolicy(t))return t;this.showAlert(`Unsupported create policy 'policies.create=${t}'`)}clearOldData(){this.props.workspace&&this.props.clearWorkspaceId(),this.resetOverrideParams(),this.setState({hasError:!1})}getSearchParam(){const{location:e}=this.props.history,{search:t}=Object(k.f)(e);return t||this.showAlert(`Repository/Devfile URL is missing. Please specify it via url query param: ${window.location.origin}${window.location.pathname}#/load-factory?url= .`),t}getLocation(e){const t=new window.URLSearchParams(e).get(\"url\");if(t)return t;this.showAlert(`Repository/Devfile URL is missing. Please specify it via url query param: ${window.location.origin}${window.location.pathname}#/load-factory?url= .`)}getAttributes(e,t){const r=new window.URLSearchParams(t);r.delete(\"url\");const a={},s=new window.URL(e);return r.forEach((e,t)=>{-1!==W.indexOf(t)&&(a[t]=e),this.updateOverrideParams(t,e),s.searchParams.append(t,e)}),a.stackName=s.toString(),a}async resolveDevfile(e){var t;try{await this.props.requestFactoryResolver(e)}catch(t){return Object(c.b)(t)?void this.resolvePrivateDevfile(t.attributes.oauth_authentication_url,e):void this.showAlert(\"Failed to resolve a devfile. \"+(t.message||\"\"))}if((null===(t=this.factoryResolver.resolver)||void 0===t?void 0:t.location)!==e)return void this.showAlert(\"Failed to resolve a devfile.\");const{source:r}=this.factoryResolver.resolver,a=new window.URLSearchParams(this.state.search),s=r&&\"repo\"!==r?`\\`${r}\\` in github repo ${e}`:\"\"+a.get(\"url\");return this.setState({devfileLocationInfo:s}),this.getTargetDevfile()}resolvePrivateDevfile(e,t){try{const r=this.props.infrastructureNamespaces.namespaces;if(1===r.length&&!r[0].attributes.phase)return void this.showAlert(\"Failed to accept the factory URL. The infrastructure namespace is required to be created. Please create a regular workspace to workaround the issue and open factory URL again.\");const a=Object(D.a)();let s=window.location.protocol+\"//\"+window.location.host;Object(D.b)(a)&&(s=a.server);const o=new URL(\"/f\",s);o.searchParams.set(\"url\",t);const i=new window.URL(e);T.a.keycloak&&i.searchParams.set(\"token\",T.a.keycloak.token);const n=i.toString()+\"&redirect_after_login=\"+o.toString();Object(D.b)(a)?window.open(n):window.location.href=n}catch(e){throw this.showAlert(\"Failed to open authentication page.\"),e}}async resolveWorkspace(e,t){let r;if(\"peruser\"===this.state.createPolicy&&(r=this.props.allWorkspaces.find(e=>e.attributes&&e.attributes.stackName===t.stackName)),!r)try{r=await this.props.createWorkspaceFromDevfile(e,void 0,void 0,t)}catch(e){return void this.showAlert(\"Failed to create a workspace. \"+e)}if(r)return r.devfile.attributes&&\"false\"===r.devfile.attributes.persistVolumes&&\"true\"!==r.devfile.attributes.asyncPersist&&this.showAlert(\"You're starting an ephemeral workspace. All changes to the source code will be lost when the workspace is stopped unless they are pushed to a remote code repository.\",a.b.warning),r;this.showAlert(\"Failed to create a workspace.\")}async startWorkspace(){const e=this.props.workspace;if(e&&this.state.currentStep!==K.START_WORKSPACE&&this.state.currentStep!==K.OPEN_IDE)try{await this.props.requestWorkspace(e),y.e[e.status]===y.e.STOPPED?(await this.props.startWorkspace(e),this.setState({currentStep:K.START_WORKSPACE})):y.e[e.status]!==y.e.RUNNING&&y.e[e.status]!==y.e.STARTING||this.setState({currentStep:K.START_WORKSPACE})}catch(e){this.showAlert(\"Getting workspace detail data failed. \"+e)}}async createWorkspaceFromFactory(){this.clearOldData();const e=this.getSearchParam();if(!e)return;this.setState({search:e,currentStep:K.CREATE_WORKSPACE});const t=this.getLocation(e);if(!t)return;const r=this.getAttributes(t,e),a=this.getCreatePolicy(r);if(!a)return;this.setState({location:t,createPolicy:a,currentStep:K.LOOKING_FOR_DEVFILE}),await Object(n.a)();const s=await this.resolveDevfile(t);if(!s)return;this.setState({currentStep:K.APPLYING_DEVFILE}),await Object(n.a)();const o=await this.resolveWorkspace(s,r);o&&(this.props.setWorkspaceId(o.id),await this.startWorkspace(),await this.openIde())}render(){const{workspace:e}=this.props,{currentStep:t,devfileLocationInfo:r,hasError:a}=this.state,s=e&&e.devfile.metadata.name?e.devfile.metadata.name:\"\",i=e?e.id:\"\";return o.a.createElement(A,{currentStep:t,hasError:a,devfileLocationInfo:r,workspaceId:i,workspaceName:s,callbacks:this.factoryLoaderCallbacks})}}z([Object(N.b)(T.a),C(\"design:type\",T.a)],G.prototype,\"keycloakAuthService\",void 0);const j=Object(i.c)(e=>({factoryResolver:e.factoryResolver,workspace:Object(P.h)(e),allWorkspaces:Object(P.a)(e),infrastructureNamespaces:e.infrastructureNamespace,preferredStorageType:Object(P.e)(e)}),{...c.a,...l.a});t.default=j(G)}}]);","extractedComments":[]}